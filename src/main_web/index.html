<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

  <title>Downstream</title>
  <meta name="title" content="Downstream">
  <meta name="description" content="Downstream">
  <meta name="viewport" content="width=device-width">

  <link href="style.css" rel="stylesheet" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒŠ</text></svg>">
</head>
<body>
  <canvas
    id="canvas"
    class="game_canvas"
    oncontextmenu="event.preventDefault()"
    tabindex="-1"
    onmousedown="event.target.focus()"
    onkeydown="event.preventDefault()"
  >
  </canvas>

  <script type="text/javascript" src="odin.js"></script>
  <script type="text/javascript" src="sfx.js"></script>
  <script>
    const odinMemoryInterface = new odin.WasmMemoryInterface();
    odinMemoryInterface.setIntSize(4);

    const odinImports = odin.setupDefaultImports(odinMemoryInterface);

    const sfx = new odin.SFX(odinMemoryInterface);

    var Module = {
      instantiateWasm: (imports, successCallback) => {
        const newImports = {
          ...odinImports,
          ...imports,
          sfx: sfx.getInterface(),
        }

        return WebAssembly.instantiateStreaming(fetch("index.wasm"), newImports).then((output) => {
          odinMemoryInterface.setExports(output.instance.exports)
          odinMemoryInterface.setMemory(output.instance.exports.memory)

          return successCallback(output.instance);
        });
      },

      onRuntimeInitialized: () => {
        wasmExports._start()
      },

      print: (() => {
        const element = document.getElementById("output");
        if (element) element.value = '';

        return (text) => {
          if (arguments.length > 1) {
            text = Array.prototype.slice.call(arguments).join(' ');
          }

          console.log(text);

          if (element) {
            element.value += text + "\n";
            element.scrollTop = element.scrollHeight;
          }
        };
      })(),

      canvas: (() => document.getElementById("canvas"))(),
    };
  </script>

  {{{ SCRIPT }}}
</body>
</html>
